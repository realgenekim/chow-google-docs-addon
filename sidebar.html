<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      .content-box {
        margin-bottom: 15px;
      }
      .content-box h4 {
        margin: 0;
        color: #333;
        font-size: 14px;
      }
      .output-panel {
        margin-top: 10px;
        white-space: pre-wrap;
        border: 1px solid #e0e0e0;
        padding: 12px;
        border-radius: 4px;
        background-color: #ffffff;
        min-height: 50px;
        color: #333;
        cursor: default;
        box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
        user-select: text;
        -webkit-user-select: text;
      }
    </style>
  </head>
  <body>
    <!-- Main title and description -->
    <!-- <h3>CHOW Workbench</h3> -->
    <div style="font-size: 11px; margin-top: -5px; margin-bottom: 8px;">Build: <span id="build-date"></span></div>
    <p>Written to make it easier to CHOW: assemble and sling prompts around to paste them into an LLM.</p>
    <br>
    
    <script>
      // Set build date on load
      document.addEventListener('DOMContentLoaded', function() {
        const buildDate = new Date();
        const month = buildDate.toLocaleString('en-US', { month: 'short' });
        const day = buildDate.getDate();
        const hour = buildDate.getHours() % 12 || 12; // Convert to 12-hour format
        const minute = String(buildDate.getMinutes()).padStart(2, '0');
        const ampm = buildDate.getHours() >= 12 ? 'pm' : 'am';
        
        document.getElementById('build-date').textContent = 
          `${month} ${day}, ${hour}:${minute}${ampm}`;
      });
    </script>
        
    <!-- Selected text display area -->
    <div class="content-box">
      <h4>Selected Text</h4>
      <div id="selected-text" class="output-panel"></div>
    </div>

    <!-- Manuscript context display area -->
    <div class="content-box">
      <h4>Manuscript Context</h4>
      <div id="manuscript-context" class="output-panel">
        Manuscript not loaded: click "Get Document" to load
      </div>
    </div>

    <br>

    <!-- Control buttons -->
    <button onclick="reloadSidebar()">Reload Sidebar</button>
    <!-- don't need these anymore  -->
    <!-- <button onclick="refreshDocCache()">Reload Documents</button> -->
    <!-- <button onclick="getSelection2()">Get Selection</button> -->
    <!-- <button onclick="generatePromptAndCopyToClipboard()">Generate Prompt and Copy to Clipboard</button> -->
    
    <!-- Part-specific buttons -->
    <div style="margin-top: 10px;">
      <button onclick="getPart1DocAndPrompt()">Part 1 Prompt to Clipboard</button>
      <button onclick="getPart2DocAndPrompt()">Part 2 Prompt to Clipboard</button>
      <button onclick="getPart3DocAndPrompt()">Part 3 Prompt to Clipboard</button>
    </div>
    <div id="debug" style="margin-top: 20px; color: red; max-height: 300px; overflow-y: auto;"></div>

    <script>
      // Function to get formatted timestamp
      function getTimestamp() {
        const now = new Date();
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const seconds = String(now.getSeconds()).padStart(2, '0');
        return `${hours}:${minutes}:${seconds}`;
      }
      
      // Function to log messages with timestamp, newest at top
      function logMessage(message) {
        const timestampedMessage = `${getTimestamp()} - ${message}`;
        const debugElement = document.getElementById('debug');
        debugElement.innerHTML = timestampedMessage + '<br>' + debugElement.innerHTML;
      }
      
      // Initialize debug output
      logMessage('BEGIN!');

      // Load initial state when window loads
      window.onload = function() {
        loadInitialState();
      };

      // Global cache variables for document content
      let cachedPart1Content = null;
      let cachedPart2Content = null;
      let cachedPart3Content = null;
      let lastPart1LoadTime = 0;
      let lastPart2LoadTime = 0;
      let lastPart3LoadTime = 0;
      const CACHE_EXPIRY_MS = 60000; // 1 minute
      
      // Get build date for title
      const BUILD_DATE = new Date();
      const BUILD_MONTH = BUILD_DATE.toLocaleString('en-US', { month: 'short' });
      const BUILD_DAY = BUILD_DATE.getDate();
      const BUILD_HOUR = BUILD_DATE.getHours();
      const BUILD_MINUTE = BUILD_DATE.getMinutes();
      const BUILD_AMPM = BUILD_HOUR >= 12 ? 'pm' : 'am';
      const BUILD_HOUR_12 = BUILD_HOUR % 12 || 12; // Convert to 12-hour format
      
      // Initialize by loading documents and selection
      function loadInitialState() {
        // Get selection immediately
        getSelection2();
        
        // Start background loading of all documents so they're ready when needed
        logMessage('Initializing document cache (preloading all parts)...');
        
        // Show compact loading indicator
        document.getElementById('manuscript-context').innerHTML = 
          '<div style="padding: 5px; background-color: #f8f9fa; border-radius: 4px; font-size: 12px; text-align: center;">' +
          '<strong>Preloading documents</strong> <span class="loading-dots"></span>' +
          '</div>';
        
        // Add some CSS for animated loading dots
        const style = document.createElement('style');
        style.textContent = `
          @keyframes loadingDots {
            0% { content: ""; }
            25% { content: "."; }
            50% { content: ".."; }
            75% { content: "..."; }
          }
          .loading-dots:after {
            content: "";
            animation: loadingDots 1.5s infinite;
            display: inline-block;
            width: 12px;
          }
        `;
        document.head.appendChild(style);
        
        // Start background loading of documents
        loadDocumentCache();
        
        // Set up periodic background refresh
        setInterval(function() {
          logMessage('Periodic cache refresh started');
          loadDocumentCache();
        }, CACHE_EXPIRY_MS);
      }
      
      // Load only the current document by default, determined by which part we're working with
      function loadDocumentCache() {
        const now = Date.now();
        
        // Detect which part we're in by looking at the active document's title
        google.script.run
          .withSuccessHandler(function(activeDocInfo) {
            // Get active document title
            const docTitle = activeDocInfo.title || "";
            logMessage('Active document: ' + docTitle);
            
            // Determine which part we're in by title
            const isPart1 = docTitle.toLowerCase().includes('part 1') || 
                            docTitle.toLowerCase().includes('part1') ||
                            docTitle.toLowerCase().includes('part-1');
            const isPart2 = docTitle.toLowerCase().includes('part 2') || 
                            docTitle.toLowerCase().includes('part2') ||
                            docTitle.toLowerCase().includes('part-2');
            const isPart3 = docTitle.toLowerCase().includes('part 3') || 
                            docTitle.toLowerCase().includes('part3') || 
                            docTitle.toLowerCase().includes('part-3');
            
            // Load only the part we're currently working with, defaulting to Part 1
            if (isPart3) {
              logMessage('Detected Part 3 document - preloading only Part 3...');
              if (!cachedPart3Content || (now - lastPart3LoadTime > CACHE_EXPIRY_MS)) {
                loadPart3InBackground();
              }
            } else if (isPart2) {
              logMessage('Detected Part 2 document - preloading only Part 2...');
              if (!cachedPart2Content || (now - lastPart2LoadTime > CACHE_EXPIRY_MS)) {
                loadPart2InBackground();
              }
            } else {
              // Default to Part 1 or if we can't determine
              logMessage('Detected Part 1 document (or couldn\'t determine) - preloading only Part 1...');
              if (!cachedPart1Content || (now - lastPart1LoadTime > CACHE_EXPIRY_MS)) {
                loadPart1InBackground();
              }
            }
            
            // After a delay, show the summary of all loaded documents
            setTimeout(function() {
              showCachedDocsSummary();
            }, 2000);
          })
          .withFailureHandler(function(error) {
            logMessage('Error detecting active document: ' + error);
            // If we can't detect which part we're in, just load Part 1 as default
            if (!cachedPart1Content || (now - lastPart1LoadTime > CACHE_EXPIRY_MS)) {
              logMessage('Falling back to loading Part 1 only...');
              loadPart1InBackground();
            }
            
            // Still show the summary after a delay
            setTimeout(function() {
              showCachedDocsSummary();
            }, 2000);
          })
          .getActiveDocumentInfo();
      }
      
      // Refresh a specific part's document cache (for targeted refreshes)
      function refreshPartCache(part) {
        const now = Date.now();
        
        switch(part) {
          case 1:
            logMessage('Refreshing Part 1 document preload...');
            // Reset the timestamp to force refresh
            lastPart1LoadTime = 0;
            loadPart1InBackground();
            break;
          case 2:
            logMessage('Refreshing Part 2 document preload...');
            // Reset the timestamp to force refresh
            lastPart2LoadTime = 0;
            loadPart2InBackground();
            break;
          case 3:
            logMessage('Refreshing Part 3 document preload...');
            // Reset the timestamp to force refresh
            lastPart3LoadTime = 0;
            loadPart3InBackground();
            break;
          default:
            logMessage('Refreshing all document preloads...');
            // Reset all timestamps to force refresh
            lastPart1LoadTime = 0;
            lastPart2LoadTime = 0;
            lastPart3LoadTime = 0;
            // Load all parts
            loadPart1InBackground();
            loadPart2InBackground();
            loadPart3InBackground();
        }
      }
      
      // Load Part 1 in background
      function loadPart1InBackground() {
        google.script.run
          .withSuccessHandler(function(content) {
            cachedPart1Content = content;
            lastPart1LoadTime = Date.now();
            
            // Calculate word count
            const wordCount = content.trim().split(/\s+/).length;
            logMessage(`✅ Part 1 document preloaded (${wordCount} words)`);
          })
          .withFailureHandler(function(error) {
            logMessage(`❌ Failed to cache Part 1: ${error}`);
          })
          .getPart1Doc();
      }
      
      // Load Part 2 in background
      function loadPart2InBackground() {
        google.script.run
          .withSuccessHandler(function(content) {
            cachedPart2Content = content;
            lastPart2LoadTime = Date.now();
            
            // Calculate word count
            const wordCount = content.trim().split(/\s+/).length;
            logMessage(`✅ Part 2 document preloaded (${wordCount} words)`);
          })
          .withFailureHandler(function(error) {
            logMessage(`❌ Failed to cache Part 2: ${error}`);
          })
          .getPart2Doc();
      }
      
      // Load Part 3 in background
      function loadPart3InBackground() {
        google.script.run
          .withSuccessHandler(function(content) {
            cachedPart3Content = content;
            lastPart3LoadTime = Date.now();
            
            // Calculate word count
            const wordCount = content.trim().split(/\s+/).length;
            
            // Check for warnings or suspiciously small word counts
            if (content.includes('WARNING: Incomplete Content Detected')) {
              // Extract word count from warning message
              const match = content.match(/Only (\d+) words were loaded/);
              const extractedCount = match ? match[1] : wordCount;
              logMessage(`⚠️ Part 3 document preloaded with WARNING: incomplete content (${extractedCount} words, expected ~11,000 words)`);
            } else if (wordCount < 1000) {
              logMessage(`⚠️ Part 3 document preloaded but content appears incomplete (${wordCount} words, expected ~11,000 words)`);
            } else {
              logMessage(`✅ Part 3 document preloaded (${wordCount} words)`);
            }
          })
          .withFailureHandler(function(error) {
            logMessage(`❌ Failed to cache Part 3: ${error}`);
          })
          .getPart3Doc();
      }

      // NOTE: getSelection() is reserved: will never be called.
      // Get the currently selected text from the document
      function getSelection2() {
        logMessage('getSelection called');
        google.script.run
          .withSuccessHandler(function(text) {
            // Check if there's actually text selected
            const hasSelection = text && text.trim() !== '' && text !== 'No text selected';
            
            // Update the UI with selected text
            if (hasSelection) {
              const debugText = text.substring(0, 250) + (text.length > 250 ? '...' : '');
              logMessage('Success handler called with text: ' + debugText);
              
              // Calculate word count
              const wordCount = text.trim().split(/\s+/).length;
              
              // Truncate to 250 characters
              const truncatedText = text.substring(0, 250);
              const hasMore = text.length > 250;
              
              // Display truncated text with word count and indication if truncated
              document.getElementById('selected-text').innerHTML = 
                truncatedText + 
                (hasMore ? '...' : '') + 
                `\n\n[${wordCount} words total]`;
            } else {
              // No text selected
              logMessage('No text currently selected');
              
              // Show placeholder with instructions
              document.getElementById('selected-text').innerHTML = 
                '<div style="color: #e67e22; padding: 5px; font-style: italic;">' +
                'No text currently selected. Select text in the document to include it in the prompt.' +
                '</div>';
            }
            
            // Save selection to global variable on server (even if empty)
            google.script.run
              .withSuccessHandler(function() {
                logMessage('Selection saved to global variable');
              })
              .setGlobalSelection(text);
          })
          .withFailureHandler(function(error) {
            logMessage('Error: ' + error);
            document.getElementById('selected-text').innerHTML = 
              '<div style="color: #e74c3c; padding: 5px;">' +
              'Error getting selection: ' + error +
              '</div>';
          })
          .getSelectedText();
      }

      // Display document summary from preloaded documents
      function showCachedDocsSummary() {
        // Create a compact formatted summary of preloaded documents
        let summaryHTML = '<div style="padding: 5px; background-color: #f8f9fa; border-radius: 4px; font-size: 12px;">';
        
        // Create a table-like layout for compact display
        summaryHTML += '<table style="width: 100%; border-collapse: collapse;">';
        summaryHTML += '<tr style="border-bottom: 1px solid #eee;">' +
                      '<th style="text-align: left; width: 30px;">Part</th>' +
                      '<th style="text-align: left;">Status</th>' +
                      '<th style="text-align: right; width: 50px;">Words</th>' +
                      '<th style="text-align: right; width: 40px;">Age</th>' +
                      '</tr>';
        
        // Part 1 summary - compact row
        if (cachedPart1Content) {
          const part1WordCount = cachedPart1Content.trim().split(/\s+/).length;
          const part1Age = Math.round((Date.now() - lastPart1LoadTime) / 1000);
          summaryHTML += '<tr>' +
                        '<td><strong>P1</strong></td>' +
                        '<td><span style="color: #2ecc71;">✓ Ready</span></td>' +
                        `<td style="text-align: right;">${part1WordCount}</td>` +
                        `<td style="text-align: right;">${part1Age}s</td>` +
                        '</tr>';
        } else {
          summaryHTML += '<tr>' +
                        '<td><strong>P1</strong></td>' +
                        '<td colspan="3"><span style="color: #7f8c8d;">Not preloaded</span></td>' +
                        '</tr>';
        }
        
        // Part 2 summary - compact row
        if (cachedPart2Content) {
          const part2WordCount = cachedPart2Content.trim().split(/\s+/).length;
          const part2Age = Math.round((Date.now() - lastPart2LoadTime) / 1000);
          summaryHTML += '<tr>' +
                        '<td><strong>P2</strong></td>' +
                        '<td><span style="color: #2ecc71;">✓ Ready</span></td>' +
                        `<td style="text-align: right;">${part2WordCount}</td>` +
                        `<td style="text-align: right;">${part2Age}s</td>` +
                        '</tr>';
        } else {
          summaryHTML += '<tr>' +
                        '<td><strong>P2</strong></td>' +
                        '<td colspan="3"><span style="color: #7f8c8d;">Not preloaded</span></td>' +
                        '</tr>';
        }
        
        // Part 3 summary - compact row
        if (cachedPart3Content) {
          const part3WordCount = cachedPart3Content.trim().split(/\s+/).length;
          const part3Age = Math.round((Date.now() - lastPart3LoadTime) / 1000);
          
          if (cachedPart3Content.includes('WARNING: Incomplete Content Detected') || part3WordCount < 1000) {
            // Extract word count from warning message if available
            const match = cachedPart3Content.match(/Only (\d+) words were loaded/);
            const extractedCount = match ? match[1] : part3WordCount;
            summaryHTML += '<tr>' +
                          '<td><strong>P3</strong></td>' +
                          '<td><span style="color: #e67e22;">⚠️ Incomplete</span></td>' +
                          `<td style="text-align: right;">${extractedCount}</td>` +
                          `<td style="text-align: right;">${part3Age}s</td>` +
                          '</tr>';
          } else {
            summaryHTML += '<tr>' +
                          '<td><strong>P3</strong></td>' +
                          '<td><span style="color: #2ecc71;">✓ Ready</span></td>' +
                          `<td style="text-align: right;">${part3WordCount}</td>` +
                          `<td style="text-align: right;">${part3Age}s</td>` +
                          '</tr>';
          }
        } else {
          summaryHTML += '<tr>' +
                        '<td><strong>P3</strong></td>' +
                        '<td colspan="3"><span style="color: #7f8c8d;">Not preloaded</span></td>' +
                        '</tr>';
        }
        
        summaryHTML += '</table>';
        summaryHTML += '</div>';
        
        // Display in the manuscript context area
        document.getElementById('manuscript-context').innerHTML = summaryHTML;
      }

      // Reload the entire sidebar
      function reloadSidebar() {
        google.script.run
          .withSuccessHandler(function() {
            console.log('Sidebar reloaded successfully.');
          })
          .withFailureHandler(function(error) {
            console.error('Error reloading sidebar: ', error);
          })
          .showSidebar();
      }
      
      // Force refresh of document cache and update UI
      function refreshDocCache() {
        logMessage('🔄 Forcing refresh of all document preloads...');
        
        // Reset all timestamps to force refresh
        lastPart1LoadTime = 0;
        lastPart2LoadTime = 0;
        lastPart3LoadTime = 0;
        
        // Show loading animation in the table
        showCachedDocsSummary();
        
        // Add loading indicators to all rows
        const rows = document.querySelectorAll('#manuscript-context table tr');
        for (let i = 1; i < rows.length; i++) { // Skip header row
          if (rows[i].cells.length > 1) {
            rows[i].cells[1].innerHTML = '<span style="color: #3498db;">⏳ Loading...</span> <span class="loading-dots"></span>';
            if (rows[i].cells.length > 2) rows[i].cells[2].innerHTML = '...';
            if (rows[i].cells.length > 3) rows[i].cells[3].innerHTML = '0s';
          }
        }
        
        // Call the refreshPartCache function to refresh all parts
        refreshPartCache(); // With no parameter, it will refresh all parts
        
        // After a delay, show the summary
        setTimeout(function() {
          showCachedDocsSummary();
        }, 2000);
      }

      // Generate prompt and copy to clipboard
      function generatePromptAndCopyToClipboard() {
        logMessage('generatePromptAndCopyToClipboard called!');
        google.script.run
          .withSuccessHandler(function(promptText) {
            try {
              // Try to copy with retry mechanism
              copyWithRetry(promptText, 0);
            } catch (err) {
              logMessage('Failed to copy: ' + err);
            }
          })
          .withFailureHandler(function(error) {
            logMessage('Error generating prompt: ' + error);
          })
          .generatePromptAndCopyToClipboard();
      }
      
      // Copy with retry logic - will try Navigator API first, then fallback, with 3 retries
      function copyWithRetry(text, attemptCount, maxRetries = 3) {
        logMessage(`🔄 Copy attempt ${attemptCount + 1}/${maxRetries + 1}...`);
        
        // Show brief feedback to user
        showTemporaryStatus('Copying to clipboard...');
        
        // Use Navigator clipboard API which is more modern and reliable
        if (navigator.clipboard && window.isSecureContext) {
          navigator.clipboard.writeText(text)
            .then(() => {
              logMessage('✅ Prompt copied to clipboard using Navigator API!');
              showTemporaryStatus('✅ Copied to clipboard!', 'success');
            })
            .catch(err => {
              logMessage(`❌ Navigator API attempt ${attemptCount + 1} failed: ${err}`);
              
              if (attemptCount < maxRetries) {
                showTemporaryStatus(`Retrying copy (${attemptCount + 2}/${maxRetries + 1})...`, 'warning');
                
                // Wait a bit before retrying (exponential backoff)
                setTimeout(() => {
                  copyWithRetry(text, attemptCount + 1, maxRetries);
                }, 100 * Math.pow(2, attemptCount));
              } else {
                logMessage('Navigator API failed after all retries, trying fallback method...');
                showTemporaryStatus('Trying alternative copy method...', 'warning');
                
                // Try fallback after all Navigator API retries fail
                fallbackCopyToClipboard(text, 0);
              }
            });
        } else {
          // Browser doesn't support Navigator API, go straight to fallback
          logMessage('Navigator clipboard API not available, using fallback method');
          fallbackCopyToClipboard(text, 0);
        }
      }
      
      // Shows a temporary status message to the user
      function showTemporaryStatus(message, type = 'info') {
        // Create status element if it doesn't exist
        var statusId = 'clipboard-status';
        var statusEl = document.getElementById(statusId);
        
        if (!statusEl) {
          statusEl = document.createElement('div');
          statusEl.id = statusId;
          statusEl.style.position = 'fixed';
          statusEl.style.bottom = '10px';
          statusEl.style.left = '50%';
          statusEl.style.transform = 'translateX(-50%)';
          statusEl.style.padding = '8px 16px';
          statusEl.style.borderRadius = '4px';
          statusEl.style.fontWeight = 'bold';
          statusEl.style.zIndex = '2000';
          statusEl.style.boxShadow = '0 2px 4px rgba(0,0,0,0.2)';
          document.body.appendChild(statusEl);
        }
        
        // Set style based on type
        switch(type) {
          case 'success':
            statusEl.style.backgroundColor = '#2ecc71';
            statusEl.style.color = 'white';
            break;
          case 'warning':
            statusEl.style.backgroundColor = '#f39c12';
            statusEl.style.color = 'white';
            break;
          case 'error':
            statusEl.style.backgroundColor = '#e74c3c';
            statusEl.style.color = 'white';
            break;
          default: // info
            statusEl.style.backgroundColor = '#3498db';
            statusEl.style.color = 'white';
        }
        
        statusEl.textContent = message;
        statusEl.style.display = 'block';
        
        // Auto-hide after 3 seconds unless it's an error
        if (type !== 'error') {
          setTimeout(function() {
            statusEl.style.display = 'none';
          }, 3000);
        }
      }
      
      // Fallback copy method using execCommand with retries
      function fallbackCopyToClipboard(text, attemptCount, maxRetries = 3) {
        logMessage(`🔄 Fallback copy attempt ${attemptCount + 1}/${maxRetries + 1}...`);
        showTemporaryStatus('Trying alternate copy method...', 'info');
        
        try {
          var textArea = document.createElement('textarea');
          textArea.value = text;
          
          // Make the textarea visible but off-screen - important for some browsers
          textArea.style.position = 'fixed';
          textArea.style.left = '0';
          textArea.style.top = '0';
          textArea.style.width = '2em';
          textArea.style.height = '2em';
          textArea.style.opacity = '0.01'; // Almost invisible but not completely
          document.body.appendChild(textArea);
          
          textArea.focus();
          textArea.select();
          
          var successful = document.execCommand('copy');
          document.body.removeChild(textArea);
          
          if (successful) {
            logMessage('✅ Prompt copied to clipboard using fallback method!');
            showTemporaryStatus('✅ Copied to clipboard!', 'success');
          } else {
            logMessage(`❌ Fallback attempt ${attemptCount + 1} failed`);
            
            if (attemptCount < maxRetries) {
              showTemporaryStatus(`Retrying alternate copy (${attemptCount + 2}/${maxRetries + 1})...`, 'warning');
              
              // Wait before retrying with exponential backoff
              setTimeout(() => {
                fallbackCopyToClipboard(text, attemptCount + 1, maxRetries);
              }, 200 * Math.pow(2, attemptCount));
            } else {
              logMessage('❌ All fallback attempts failed, showing manual copy interface');
              showTemporaryStatus('Automatic copy failed. Manual copy required.', 'error');
              setTimeout(() => {
                showCopyPrompt(text);
              }, 500); // Slight delay before showing manual interface
            }
          }
        } catch (err) {
          logMessage(`❌ Fallback attempt ${attemptCount + 1} error: ${err}`);
          
          if (attemptCount < maxRetries) {
            showTemporaryStatus(`Retrying alternate copy (${attemptCount + 2}/${maxRetries + 1})...`, 'warning');
            
            // Wait before retrying with exponential backoff
            setTimeout(() => {
              fallbackCopyToClipboard(text, attemptCount + 1, maxRetries);
            }, 200 * Math.pow(2, attemptCount));
          } else {
            logMessage('❌ All fallback attempts failed, showing manual copy interface');
            showTemporaryStatus('Automatic copy failed. Manual copy required.', 'error');
            setTimeout(() => {
              showCopyPrompt(text);
            }, 500); // Slight delay before showing manual interface
          }
        }
      }
      
      // Last resort: show text for manual copy
      function showCopyPrompt(text) {
        logMessage('⚠️ Showing manual copy interface as last resort');
        
        // Create a modal dialog
        var copyArea = document.createElement('div');
        copyArea.style.position = 'fixed';
        copyArea.style.left = '5%';
        copyArea.style.top = '5%';
        copyArea.style.width = '90%';
        copyArea.style.height = '90%';
        copyArea.style.backgroundColor = 'white';
        copyArea.style.zIndex = '1000';
        copyArea.style.padding = '20px';
        copyArea.style.border = '2px solid #e74c3c';
        copyArea.style.borderRadius = '5px';
        copyArea.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
        copyArea.style.overflow = 'auto';
        
        // Create header
        var header = document.createElement('h3');
        header.innerText = 'Manual Copy Required';
        header.style.color = '#e74c3c';
        header.style.margin = '0 0 15px 0';
        
        // Create instructions
        var instructions = document.createElement('p');
        instructions.innerText = 'Automatic clipboard operations failed. Please use Ctrl+C (or ⌘+C on Mac) to manually copy this text:';
        
        // Create copy button
        var copyButton = document.createElement('button');
        copyButton.innerText = 'Try Copy Again';
        copyButton.style.marginRight = '10px';
        copyButton.style.padding = '5px 10px';
        copyButton.style.backgroundColor = '#3498db';
        copyButton.style.color = 'white';
        copyButton.style.border = 'none';
        copyButton.style.borderRadius = '3px';
        copyButton.style.cursor = 'pointer';
        copyButton.onclick = function() {
          textDisplay.select();
          try {
            var success = document.execCommand('copy');
            if (success) {
              statusText.innerText = 'Copy successful!';
              statusText.style.color = 'green';
            } else {
              statusText.innerText = 'Copy failed. Please use keyboard shortcut (Ctrl+C or ⌘+C).';
              statusText.style.color = 'red';
            }
          } catch (err) {
            statusText.innerText = 'Error: ' + err;
            statusText.style.color = 'red';
          }
        };
        
        // Create close button
        var closeButton = document.createElement('button');
        closeButton.innerText = 'Close';
        closeButton.style.padding = '5px 10px';
        closeButton.style.backgroundColor = '#e74c3c';
        closeButton.style.color = 'white';
        closeButton.style.border = 'none';
        closeButton.style.borderRadius = '3px';
        closeButton.style.cursor = 'pointer';
        closeButton.onclick = function() {
          document.body.removeChild(copyArea);
        };
        
        // Create status text
        var statusText = document.createElement('span');
        statusText.innerText = 'Ready to copy';
        statusText.style.marginLeft = '10px';
        
        // Create textarea
        var textDisplay = document.createElement('textarea');
        textDisplay.value = text;
        textDisplay.style.width = '100%';
        textDisplay.style.height = '70%';
        textDisplay.style.marginTop = '10px';
        textDisplay.style.marginBottom = '10px';
        textDisplay.style.padding = '8px';
        textDisplay.style.border = '1px solid #ccc';
        textDisplay.style.borderRadius = '3px';
        textDisplay.style.fontSize = '14px';
        
        // Button container
        var buttonContainer = document.createElement('div');
        buttonContainer.appendChild(copyButton);
        buttonContainer.appendChild(closeButton);
        buttonContainer.appendChild(statusText);
        
        // Build the modal
        copyArea.appendChild(header);
        copyArea.appendChild(instructions);
        copyArea.appendChild(textDisplay);
        copyArea.appendChild(buttonContainer);
        
        document.body.appendChild(copyArea);
        
        // Select all text for easy copying
        textDisplay.select();
        
        // Try to add keyboard shortcut focus listener
        textDisplay.addEventListener('keydown', function(e) {
          // Detect Ctrl+C or Cmd+C
          if ((e.ctrlKey || e.metaKey) && e.keyCode === 67) {
            statusText.innerText = 'Keyboard shortcut detected - copy likely successful!';
            statusText.style.color = 'green';
          }
        });
      }
      
      // Get Part 1 document and generate prompt
      function getPart1DocAndPrompt() {
        logMessage('Getting Part 1 document...');
        
        // First get the latest selection, then use cached document or load if needed
        logMessage('Updating selected text first...');
        getSelectionThenUsePart1();
      }
      
      // Helper function to get selection before using Part 1
      function getSelectionThenUsePart1() {
        google.script.run
          .withSuccessHandler(function(selectedText) {
            // Log selection status
            if (selectedText && selectedText.trim() !== '' && selectedText !== 'No text selected') {
              const wordCount = selectedText.trim().split(/\s+/).length;
              logMessage(`Selection updated: ${wordCount} words`);
            } else {
              logMessage('⚠️ No text currently selected');
            }
            
            // Save selection to global variable on server (even if empty)
            google.script.run
              .withSuccessHandler(function() {
                logMessage('Selection saved to global variable for Part 1 prompt');
                // Now proceed with Part 1 - use cached version if available
                useCachedOrLoadPart1();
              })
              .withFailureHandler(function(error) {
                logMessage('Error saving selection: ' + error);
                // Still proceed with Part 1
                useCachedOrLoadPart1();
              })
              .setGlobalSelection(selectedText);
          })
          .withFailureHandler(function(error) {
            logMessage('Error getting selection: ' + error);
            // Still proceed with using Part 1
            useCachedOrLoadPart1();
          })
          .getSelectedText();
      }
      
      // Helper function to use cached Part 1 or load if needed
      function useCachedOrLoadPart1() {
        // Check if we have a valid cache
        const now = Date.now();
        if (cachedPart1Content && (now - lastPart1LoadTime <= CACHE_EXPIRY_MS)) {
          logMessage('✅ Using cached Part 1 document (fast)');
          processPart1Content(cachedPart1Content);
        } else {
          // Cache is invalid or missing, need to load
          logMessage('Cache expired or missing, loading Part 1 document (takes about 15s)...');
          
          // Reset the timestamp to force refresh
          lastPart1LoadTime = 0;
          
          // Update the status in the compact table instead of replacing it
          showCachedDocsSummary();
          
          // Add a loading indicator to the Part 1 row only
          const part1Row = document.querySelector('#manuscript-context table tr:nth-child(2)');
          if (part1Row) {
            part1Row.cells[1].innerHTML = '<span style="color: #3498db;">⏳ Loading...</span> <span class="loading-dots"></span>';
            part1Row.cells[2].innerHTML = '...';
            part1Row.cells[3].innerHTML = '0s';
          }
          
          google.script.run
            .withSuccessHandler(function(content) {
              // Update cache
              cachedPart1Content = content;
              lastPart1LoadTime = Date.now();
              
              // Process the content
              processPart1Content(content);
            })
            .withFailureHandler(function(error) {
              logMessage('Error: ' + error);
              // Show error message
              document.getElementById('manuscript-context').innerHTML = 
                '<div style="color: #e74c3c; background-color: #fadbd8; padding: 10px; border-radius: 4px; border: 1px solid #e74c3c;">' +
                '<strong>⚠️ Error</strong><br><br>' + error + '</div>';
            })
            .getPart1Doc();
        }
      }
      
      // Process the Part 1 content (either from cache or freshly loaded)
      function processPart1Content(content) {
        // Check for access errors
        if (content.includes('Access Error') || content.includes('Error Accessing Document')) {
          logMessage('⚠️ Document access error detected');
          
          // Show warning message in the manuscript context area
          document.getElementById('manuscript-context').innerHTML = 
            '<div style="color: #e74c3c; background-color: #fadbd8; padding: 10px; border-radius: 4px; border: 1px solid #e74c3c;">' +
            '<strong>⚠️ Document Access Error</strong><br><br>' +
            'Could not access the Part 1 document. This document may not be shared with your Google account.<br><br>' +
            '<strong>To fix this issue:</strong><br>' +
            '1. Make sure you\'re logged in with the correct Google account<br>' +
            '2. Ask the document owner to share it with your email address<br>' +
            '3. Open the document directly in Google Docs first to accept any sharing invitations<br><br>' +
            '<em>Note: The prompt will still be generated using placeholder text for Part 1.</em>' +
            '</div>';
            
          // Continue with prompt generation despite error
          logMessage('Continuing with prompt generation using placeholder content...');
          generatePromptAndCopyToClipboard();
        } else {
          // Normal flow - no errors
          var wordCount = content.trim().split(/\s+/).length;
          document.getElementById('manuscript-context').innerHTML = 'Part 1 Word count: ' + wordCount;
          logMessage('Part 1 ready, generating prompt...');
          
          // Generate and copy the prompt
          generatePromptAndCopyToClipboard();
        }
      }
      
      // Get Part 2 document and generate prompt
      function getPart2DocAndPrompt() {
        logMessage('Getting Part 2 document (using PART1_SUMMARY constant instead of loading Part 1)...');
        
        // First get the latest selection, then use cached document or load if needed
        logMessage('Updating selected text first...');
        getSelectionThenUsePart2();
      }
      
      // Helper function to get selection before using Part 2
      function getSelectionThenUsePart2() {
        google.script.run
          .withSuccessHandler(function(selectedText) {
            // Log selection status
            if (selectedText && selectedText.trim() !== '' && selectedText !== 'No text selected') {
              const wordCount = selectedText.trim().split(/\s+/).length;
              logMessage(`Selection updated: ${wordCount} words`);
            } else {
              logMessage('⚠️ No text currently selected');
            }
            
            // Save selection to global variable on server (even if empty)
            google.script.run
              .withSuccessHandler(function() {
                logMessage('Selection saved to global variable for Part 2 prompt');
                // Now proceed with Part 2 - use cached version if available
                useCachedOrLoadPart2();
              })
              .withFailureHandler(function(error) {
                logMessage('Error saving selection: ' + error);
                // Still proceed with Part 2
                useCachedOrLoadPart2();
              })
              .setGlobalSelection(selectedText);
          })
          .withFailureHandler(function(error) {
            logMessage('Error getting selection: ' + error);
            // Still proceed with using Part 2
            useCachedOrLoadPart2();
          })
          .getSelectedText();
      }
      
      // Helper function to use cached Part 2 or load if needed
      function useCachedOrLoadPart2() {
        // Check if we have a valid cache
        const now = Date.now();
        if (cachedPart2Content && (now - lastPart2LoadTime <= CACHE_EXPIRY_MS)) {
          logMessage('✅ Using cached Part 2 document (fast)');
          processPart2Content(cachedPart2Content);
        } else {
          // Cache is invalid or missing, need to load
          logMessage('Cache expired or missing, loading Part 2 document (takes about 15s)...');
          
          // Reset the timestamp to force refresh
          lastPart2LoadTime = 0;
          
          // Update the status in the compact table instead of replacing it
          showCachedDocsSummary();
          
          // Add a loading indicator to the Part 2 row only
          const part2Row = document.querySelector('#manuscript-context table tr:nth-child(3)');
          if (part2Row) {
            part2Row.cells[1].innerHTML = '<span style="color: #3498db;">⏳ Loading...</span> <span class="loading-dots"></span>';
            part2Row.cells[2].innerHTML = '...';
            part2Row.cells[3].innerHTML = '0s';
          }
          
          google.script.run
            .withSuccessHandler(function(content) {
              // Update cache
              cachedPart2Content = content;
              lastPart2LoadTime = Date.now();
              
              // Process the content
              processPart2Content(content);
            })
            .withFailureHandler(function(error) {
              logMessage('Error: ' + error);
              // Show error message
              document.getElementById('manuscript-context').innerHTML = 
                '<div style="color: #e74c3c; background-color: #fadbd8; padding: 10px; border-radius: 4px; border: 1px solid #e74c3c;">' +
                '<strong>⚠️ Error</strong><br><br>' + error + '</div>';
            })
            .getPart2Doc();
        }
      }
      
      // Process the Part 2 content (either from cache or freshly loaded)
      function processPart2Content(content) {
        // Check for access errors
        if (content.includes('Access Error') || content.includes('Error Accessing Document')) {
          logMessage('⚠️ Document access error detected');
          
          // Show warning message in the manuscript context area
          document.getElementById('manuscript-context').innerHTML = 
            '<div style="color: #e74c3c; background-color: #fadbd8; padding: 10px; border-radius: 4px; border: 1px solid #e74c3c;">' +
            '<strong>⚠️ Document Access Error</strong><br><br>' +
            'Could not access the Part 2 document. This document may not be shared with your Google account.<br><br>' +
            '<strong>To fix this issue:</strong><br>' +
            '1. Make sure you\'re logged in with the correct Google account<br>' +
            '2. Ask the document owner to share it with your email address<br>' +
            '3. Open the document directly in Google Docs first to accept any sharing invitations<br><br>' +
            '<em>Note: The prompt will still be generated using the Part 1 summary and placeholder text for Part 2.</em>' +
            '</div>';
            
          // Continue with prompt generation despite error
          logMessage('Continuing with prompt generation using placeholder content...');
          generatePromptAndCopyToClipboard();
        } else {
          // Normal flow - no errors
          var wordCount = content.trim().split(/\s+/).length;
          document.getElementById('manuscript-context').innerHTML = 
            `<div style="padding: 10px; background-color: #f8f9fa; border-radius: 4px;">
              <strong>Part 2:</strong> ${wordCount} words<br>
              <em>Note: Using PART1_SUMMARY constant instead of loading Part 1 document</em>
            </div>`;
          logMessage('Part 2 ready, generating prompt with PART1_SUMMARY...');
          
          // Generate and copy the prompt
          generatePromptAndCopyToClipboard();
        }
      }
      
      // Get Part 3 document and generate prompt
      function getPart3DocAndPrompt() {
        logMessage('Getting Part 3 document...');
        
        // First get the latest selection, then use cached document or load if needed
        logMessage('Updating selected text first...');
        getSelectionThenUsePart3();
      }
      
      // Helper function to get selection before using Part 3
      function getSelectionThenUsePart3() {
        google.script.run
          .withSuccessHandler(function(selectedText) {
            // Log selection status
            if (selectedText && selectedText.trim() !== '' && selectedText !== 'No text selected') {
              const wordCount = selectedText.trim().split(/\s+/).length;
              logMessage(`Selection updated: ${wordCount} words`);
            } else {
              logMessage('⚠️ No text currently selected');
            }
            
            // Save selection to global variable on server (even if empty)
            google.script.run
              .withSuccessHandler(function() {
                logMessage('Selection saved to global variable for Part 3 prompt');
                // Now proceed with Part 3 - use cached version if available
                useCachedOrLoadPart3();
              })
              .withFailureHandler(function(error) {
                logMessage('Error saving selection: ' + error);
                // Still proceed with Part 3
                useCachedOrLoadPart3();
              })
              .setGlobalSelection(selectedText);
          })
          .withFailureHandler(function(error) {
            logMessage('Error getting selection: ' + error);
            // Still proceed with using Part 3
            useCachedOrLoadPart3();
          })
          .getSelectedText();
      }
      
      // Helper function to use cached Part 3 or load if needed
      function useCachedOrLoadPart3() {
        // Check if we have a valid cache
        const now = Date.now();
        if (cachedPart3Content && (now - lastPart3LoadTime <= CACHE_EXPIRY_MS)) {
          logMessage('✅ Using cached Part 3 document (fast)');
          processPart3Content(cachedPart3Content);
        } else {
          // Cache is invalid or missing, need to load
          logMessage('Cache expired or missing, loading Part 3 document (takes about 15s)...');
          
          // Reset the timestamp to force refresh
          lastPart3LoadTime = 0;
          
          // Update the status in the compact table instead of replacing it
          showCachedDocsSummary();
          
          // Add a loading indicator to the Part 3 row only
          const part3Row = document.querySelector('#manuscript-context table tr:nth-child(4)');
          if (part3Row) {
            part3Row.cells[1].innerHTML = '<span style="color: #3498db;">⏳ Loading...</span> <span class="loading-dots"></span>';
            part3Row.cells[2].innerHTML = '...';
            part3Row.cells[3].innerHTML = '0s';
          }
          
          google.script.run
            .withSuccessHandler(function(content) {
              // Update cache
              cachedPart3Content = content;
              lastPart3LoadTime = Date.now();
              
              // Process the content
              processPart3Content(content);
            })
            .withFailureHandler(function(error) {
              logMessage('Error: ' + error);
              // Show error message
              document.getElementById('manuscript-context').innerHTML = 
                '<div style="color: #e74c3c; background-color: #fadbd8; padding: 10px; border-radius: 4px; border: 1px solid #e74c3c;">' +
                '<strong>⚠️ Error</strong><br><br>' + error + '</div>';
            })
            .getPart3Doc();
        }
      }
      
      // Process the Part 3 content
      function processPart3Content(content) {
        // Check for access errors or warning about incomplete content
        if (content.includes('Access Error') || content.includes('Error Accessing Document')) {
          logMessage('⚠️ Document access error detected');
          
          // Show warning message in the manuscript context area
          document.getElementById('manuscript-context').innerHTML = 
            '<div style="color: #e74c3c; background-color: #fadbd8; padding: 10px; border-radius: 4px; border: 1px solid #e74c3c;">' +
            '<strong>⚠️ Document Access Error</strong><br><br>' +
            'Could not access the Part 3 document. This document may not be shared with your Google account.<br><br>' +
            '<strong>To fix this issue:</strong><br>' +
            '1. Make sure you\'re logged in with the correct Google account<br>' +
            '2. Ask the document owner to share it with your email address<br>' +
            '3. Open the document directly in Google Docs first to accept any sharing invitations<br><br>' +
            '<em>Note: The prompt will still be generated using Part 2 summary and placeholder text for Part 3.</em>' +
            '</div>';
            
          // Continue with prompt generation despite error
          logMessage('Continuing with prompt generation using placeholder content...');
          generatePromptAndCopyToClipboard();
        } else if (content.includes('WARNING: Incomplete Content Detected')) {
          logMessage('⚠️ Incomplete content warning detected');
          
          // Parse the word count from the content
          const wordCountMatch = content.match(/Only (\d+) words were loaded/);
          const wordCount = wordCountMatch ? wordCountMatch[1] : 'unknown';
          
          // Show warning message in the manuscript context area
          document.getElementById('manuscript-context').innerHTML = 
            '<div style="color: #e67e22; background-color: #fef9e7; padding: 10px; border-radius: 4px; border: 1px solid #e67e22;">' +
            '<strong>⚠️ Incomplete Document Warning</strong><br><br>' +
            `Only ${wordCount} words were loaded for Part 3, but it should be ~11,000 words.<br><br>` +
            '<strong>Possible causes:</strong><br>' +
            '1. The document ID may be incorrect<br>' +
            '2. You may not have proper access to the document<br>' +
            '3. The document may be empty or contain limited content<br>' +
            '4. There may be a technical issue with the document export<br><br>' +
            '<em>Note: The prompt will still be generated, but may not contain complete Part 3 content.</em>' +
            '</div>';
            
          // Continue with prompt generation despite warning
          logMessage(`Continuing with prompt generation using incomplete content (${wordCount} words)...`);
          generatePromptAndCopyToClipboard();
        } else {
          // Normal flow - no errors
          var wordCount = content.trim().split(/\s+/).length;
          
          // Check if content seems suspiciously short but didn't trigger the warning
          if (wordCount < 1000) {
            document.getElementById('manuscript-context').innerHTML = 
              `<div style="padding: 10px; background-color: #fef9e7; border-radius: 4px; border: 1px solid #e67e22;">
                <strong>⚠️ Part 3:</strong> Only ${wordCount} words loaded (expected ~11,000 words)<br>
                The document appears to be incomplete. The prompt may not contain all necessary content.
              </div>`;
            logMessage(`⚠️ Part 3 content suspiciously short (${wordCount} words) but proceeding...`);
          } else {
            document.getElementById('manuscript-context').innerHTML = 
              `<div style="padding: 10px; background-color: #f8f9fa; border-radius: 4px;">
                <strong>Part 3:</strong> ${wordCount} words
              </div>`;
            logMessage(`Part 3 ready, generating prompt (${wordCount} words)...`);
          }
          
          // Generate and copy the prompt
          generatePromptAndCopyToClipboard();
        }
      }
    </script>
  </body>
</html>

































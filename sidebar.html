<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      .content-box {
        margin-bottom: 15px;
      }
      .content-box h4 {
        margin: 0;
        color: #333;
        font-size: 14px;
      }
      .output-panel {
        margin-top: 10px;
        white-space: pre-wrap;
        border: 1px solid #e0e0e0;
        padding: 12px;
        border-radius: 4px;
        background-color: #ffffff;
        min-height: 50px;
        color: #333;
        cursor: default;
        box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
        user-select: text;
        -webkit-user-select: text;
      }
    </style>
  </head>
  <body>
    <!-- Main title and description -->
    <h3>CHOW Workbench 6</h3>
    <p>Written to make it easier to CHOW: assemble and sling prompts around to paste them into an LLM.</p>
    <br>
        
    <!-- Selected text display area -->
    <div class="content-box">
      <h4>Selected Text</h4>
      <div id="selected-text" class="output-panel"></div>
    </div>

    <!-- Manuscript context display area -->
    <div class="content-box">
      <h4>Manuscript Context</h4>
      <div id="manuscript-context" class="output-panel">
        Manuscript not loaded: click "Get Document" to load
      </div>
    </div>

    <br>

    <!-- Control buttons -->
    <button onclick="reloadSidebar()">Reload Sidebar</button>
    <button onclick="getDoc()">Reload Source Docs</button>
    <button onclick="getSelection2()">Get Selection</button>
    <button onclick="generatePromptAndCopyToClipboard()">Generate Prompt and Copy to Clipboard</button>
    
    <!-- Part-specific buttons -->
    <div style="margin-top: 10px;">
      <button onclick="getPart1DocAndPrompt()">Part 1 Prompt to Clipboard</button>
      <button onclick="getPart2DocAndPrompt()">Part 2 Prompt to Clipboard</button>
    </div>
    <div id="debug" style="margin-top: 20px; color: red; max-height: 300px; overflow-y: auto;"></div>

    <script>
      // Function to get formatted timestamp
      function getTimestamp() {
        const now = new Date();
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const seconds = String(now.getSeconds()).padStart(2, '0');
        return `${hours}:${minutes}:${seconds}`;
      }
      
      // Function to log messages with timestamp, newest at top
      function logMessage(message) {
        const timestampedMessage = `${getTimestamp()} - ${message}`;
        const debugElement = document.getElementById('debug');
        debugElement.innerHTML = timestampedMessage + '<br>' + debugElement.innerHTML;
      }
      
      // Initialize debug output
      logMessage('BEGIN!');

      // Load initial state when window loads
      window.onload = function() {
        loadInitialState();
      };

      // Initialize by loading document and selection
      function loadInitialState() {
        getDoc();
        getSelection2();
      }

      // NOTE: getSelection() is reserved: will never be called.
      // Get the currently selected text from the document
      function getSelection2() {
        logMessage('getSelection called');
        google.script.run
          .withSuccessHandler(function(text) {
            // Update the UI with selected text
            const debugText = text.substring(0, 250) + (text.length > 250 ? '...' : '');
            logMessage('Success handler called with text: ' + debugText);
            
            // Calculate word count
            const wordCount = text.trim().split(/\s+/).length;
            
            // Truncate to 250 characters
            const truncatedText = text.substring(0, 250);
            const hasMore = text.length > 250;
            
            // Display truncated text with word count and indication if truncated
            document.getElementById('selected-text').innerHTML = 
              truncatedText + 
              (hasMore ? '...' : '') + 
              `\n\n[${wordCount} words total]`;
            
            // Save selection to global variable on server
            google.script.run
              .withSuccessHandler(function() {
                logMessage('Selection saved to global variable');
              })
              .setGlobalSelection(text);
          })
          .withFailureHandler(function(error) {
            logMessage('Error: ' + error);
          })
          .getSelectedText();
      }

      // Load the document content
      function getDoc() {
        logMessage('getDoc called! (takes about 15s to load)');
        google.script.run
          .withSuccessHandler(function(content) {
            // Calculate and display word count
            var wordCount = content.trim().split(/\s+/).length;
            document.getElementById('manuscript-context').innerHTML = 'Word count: ' + wordCount;
            logMessage('Document loaded, word count: ' + wordCount);
          })
          .withFailureHandler(function(error) {
            logMessage('Error: ' + error);
          })
          .getDoc();
        logMessage('getDoc request sent, waiting for response...');
      }

      // Reload the entire sidebar
      function reloadSidebar() {
        google.script.run
          .withSuccessHandler(function() {
            console.log('Sidebar reloaded successfully.');
          })
          .withFailureHandler(function(error) {
            console.error('Error reloading sidebar: ', error);
          })
          .showSidebar();
      }

      // Generate prompt and copy to clipboard
      function generatePromptAndCopyToClipboard() {
        logMessage('generatePromptAndCopyToClipboard called!');
        google.script.run
          .withSuccessHandler(function(promptText) {
            try {
              // Try to copy with retry mechanism
              copyWithRetry(promptText, 0);
            } catch (err) {
              logMessage('Failed to copy: ' + err);
            }
          })
          .withFailureHandler(function(error) {
            logMessage('Error generating prompt: ' + error);
          })
          .generatePromptAndCopyToClipboard();
      }
      
      // Copy with retry logic - will try Navigator API first, then fallback, with 3 retries
      function copyWithRetry(text, attemptCount, maxRetries = 3) {
        logMessage(`üîÑ Copy attempt ${attemptCount + 1}/${maxRetries + 1}...`);
        
        // Show brief feedback to user
        showTemporaryStatus('Copying to clipboard...');
        
        // Use Navigator clipboard API which is more modern and reliable
        if (navigator.clipboard && window.isSecureContext) {
          navigator.clipboard.writeText(text)
            .then(() => {
              logMessage('‚úÖ Prompt copied to clipboard using Navigator API!');
              showTemporaryStatus('‚úÖ Copied to clipboard!', 'success');
            })
            .catch(err => {
              logMessage(`‚ùå Navigator API attempt ${attemptCount + 1} failed: ${err}`);
              
              if (attemptCount < maxRetries) {
                showTemporaryStatus(`Retrying copy (${attemptCount + 2}/${maxRetries + 1})...`, 'warning');
                
                // Wait a bit before retrying (exponential backoff)
                setTimeout(() => {
                  copyWithRetry(text, attemptCount + 1, maxRetries);
                }, 100 * Math.pow(2, attemptCount));
              } else {
                logMessage('Navigator API failed after all retries, trying fallback method...');
                showTemporaryStatus('Trying alternative copy method...', 'warning');
                
                // Try fallback after all Navigator API retries fail
                fallbackCopyToClipboard(text, 0);
              }
            });
        } else {
          // Browser doesn't support Navigator API, go straight to fallback
          logMessage('Navigator clipboard API not available, using fallback method');
          fallbackCopyToClipboard(text, 0);
        }
      }
      
      // Shows a temporary status message to the user
      function showTemporaryStatus(message, type = 'info') {
        // Create status element if it doesn't exist
        var statusId = 'clipboard-status';
        var statusEl = document.getElementById(statusId);
        
        if (!statusEl) {
          statusEl = document.createElement('div');
          statusEl.id = statusId;
          statusEl.style.position = 'fixed';
          statusEl.style.bottom = '10px';
          statusEl.style.left = '50%';
          statusEl.style.transform = 'translateX(-50%)';
          statusEl.style.padding = '8px 16px';
          statusEl.style.borderRadius = '4px';
          statusEl.style.fontWeight = 'bold';
          statusEl.style.zIndex = '2000';
          statusEl.style.boxShadow = '0 2px 4px rgba(0,0,0,0.2)';
          document.body.appendChild(statusEl);
        }
        
        // Set style based on type
        switch(type) {
          case 'success':
            statusEl.style.backgroundColor = '#2ecc71';
            statusEl.style.color = 'white';
            break;
          case 'warning':
            statusEl.style.backgroundColor = '#f39c12';
            statusEl.style.color = 'white';
            break;
          case 'error':
            statusEl.style.backgroundColor = '#e74c3c';
            statusEl.style.color = 'white';
            break;
          default: // info
            statusEl.style.backgroundColor = '#3498db';
            statusEl.style.color = 'white';
        }
        
        statusEl.textContent = message;
        statusEl.style.display = 'block';
        
        // Auto-hide after 3 seconds unless it's an error
        if (type !== 'error') {
          setTimeout(function() {
            statusEl.style.display = 'none';
          }, 3000);
        }
      }
      
      // Fallback copy method using execCommand with retries
      function fallbackCopyToClipboard(text, attemptCount, maxRetries = 3) {
        logMessage(`üîÑ Fallback copy attempt ${attemptCount + 1}/${maxRetries + 1}...`);
        showTemporaryStatus('Trying alternate copy method...', 'info');
        
        try {
          var textArea = document.createElement('textarea');
          textArea.value = text;
          
          // Make the textarea visible but off-screen - important for some browsers
          textArea.style.position = 'fixed';
          textArea.style.left = '0';
          textArea.style.top = '0';
          textArea.style.width = '2em';
          textArea.style.height = '2em';
          textArea.style.opacity = '0.01'; // Almost invisible but not completely
          document.body.appendChild(textArea);
          
          textArea.focus();
          textArea.select();
          
          var successful = document.execCommand('copy');
          document.body.removeChild(textArea);
          
          if (successful) {
            logMessage('‚úÖ Prompt copied to clipboard using fallback method!');
            showTemporaryStatus('‚úÖ Copied to clipboard!', 'success');
          } else {
            logMessage(`‚ùå Fallback attempt ${attemptCount + 1} failed`);
            
            if (attemptCount < maxRetries) {
              showTemporaryStatus(`Retrying alternate copy (${attemptCount + 2}/${maxRetries + 1})...`, 'warning');
              
              // Wait before retrying with exponential backoff
              setTimeout(() => {
                fallbackCopyToClipboard(text, attemptCount + 1, maxRetries);
              }, 200 * Math.pow(2, attemptCount));
            } else {
              logMessage('‚ùå All fallback attempts failed, showing manual copy interface');
              showTemporaryStatus('Automatic copy failed. Manual copy required.', 'error');
              setTimeout(() => {
                showCopyPrompt(text);
              }, 500); // Slight delay before showing manual interface
            }
          }
        } catch (err) {
          logMessage(`‚ùå Fallback attempt ${attemptCount + 1} error: ${err}`);
          
          if (attemptCount < maxRetries) {
            showTemporaryStatus(`Retrying alternate copy (${attemptCount + 2}/${maxRetries + 1})...`, 'warning');
            
            // Wait before retrying with exponential backoff
            setTimeout(() => {
              fallbackCopyToClipboard(text, attemptCount + 1, maxRetries);
            }, 200 * Math.pow(2, attemptCount));
          } else {
            logMessage('‚ùå All fallback attempts failed, showing manual copy interface');
            showTemporaryStatus('Automatic copy failed. Manual copy required.', 'error');
            setTimeout(() => {
              showCopyPrompt(text);
            }, 500); // Slight delay before showing manual interface
          }
        }
      }
      
      // Last resort: show text for manual copy
      function showCopyPrompt(text) {
        logMessage('‚ö†Ô∏è Showing manual copy interface as last resort');
        
        // Create a modal dialog
        var copyArea = document.createElement('div');
        copyArea.style.position = 'fixed';
        copyArea.style.left = '5%';
        copyArea.style.top = '5%';
        copyArea.style.width = '90%';
        copyArea.style.height = '90%';
        copyArea.style.backgroundColor = 'white';
        copyArea.style.zIndex = '1000';
        copyArea.style.padding = '20px';
        copyArea.style.border = '2px solid #e74c3c';
        copyArea.style.borderRadius = '5px';
        copyArea.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
        copyArea.style.overflow = 'auto';
        
        // Create header
        var header = document.createElement('h3');
        header.innerText = 'Manual Copy Required';
        header.style.color = '#e74c3c';
        header.style.margin = '0 0 15px 0';
        
        // Create instructions
        var instructions = document.createElement('p');
        instructions.innerText = 'Automatic clipboard operations failed. Please use Ctrl+C (or ‚åò+C on Mac) to manually copy this text:';
        
        // Create copy button
        var copyButton = document.createElement('button');
        copyButton.innerText = 'Try Copy Again';
        copyButton.style.marginRight = '10px';
        copyButton.style.padding = '5px 10px';
        copyButton.style.backgroundColor = '#3498db';
        copyButton.style.color = 'white';
        copyButton.style.border = 'none';
        copyButton.style.borderRadius = '3px';
        copyButton.style.cursor = 'pointer';
        copyButton.onclick = function() {
          textDisplay.select();
          try {
            var success = document.execCommand('copy');
            if (success) {
              statusText.innerText = 'Copy successful!';
              statusText.style.color = 'green';
            } else {
              statusText.innerText = 'Copy failed. Please use keyboard shortcut (Ctrl+C or ‚åò+C).';
              statusText.style.color = 'red';
            }
          } catch (err) {
            statusText.innerText = 'Error: ' + err;
            statusText.style.color = 'red';
          }
        };
        
        // Create close button
        var closeButton = document.createElement('button');
        closeButton.innerText = 'Close';
        closeButton.style.padding = '5px 10px';
        closeButton.style.backgroundColor = '#e74c3c';
        closeButton.style.color = 'white';
        closeButton.style.border = 'none';
        closeButton.style.borderRadius = '3px';
        closeButton.style.cursor = 'pointer';
        closeButton.onclick = function() {
          document.body.removeChild(copyArea);
        };
        
        // Create status text
        var statusText = document.createElement('span');
        statusText.innerText = 'Ready to copy';
        statusText.style.marginLeft = '10px';
        
        // Create textarea
        var textDisplay = document.createElement('textarea');
        textDisplay.value = text;
        textDisplay.style.width = '100%';
        textDisplay.style.height = '70%';
        textDisplay.style.marginTop = '10px';
        textDisplay.style.marginBottom = '10px';
        textDisplay.style.padding = '8px';
        textDisplay.style.border = '1px solid #ccc';
        textDisplay.style.borderRadius = '3px';
        textDisplay.style.fontSize = '14px';
        
        // Button container
        var buttonContainer = document.createElement('div');
        buttonContainer.appendChild(copyButton);
        buttonContainer.appendChild(closeButton);
        buttonContainer.appendChild(statusText);
        
        // Build the modal
        copyArea.appendChild(header);
        copyArea.appendChild(instructions);
        copyArea.appendChild(textDisplay);
        copyArea.appendChild(buttonContainer);
        
        document.body.appendChild(copyArea);
        
        // Select all text for easy copying
        textDisplay.select();
        
        // Try to add keyboard shortcut focus listener
        textDisplay.addEventListener('keydown', function(e) {
          // Detect Ctrl+C or Cmd+C
          if ((e.ctrlKey || e.metaKey) && e.keyCode === 67) {
            statusText.innerText = 'Keyboard shortcut detected - copy likely successful!';
            statusText.style.color = 'green';
          }
        });
      }
      
      // Get Part 1 document and generate prompt
      function getPart1DocAndPrompt() {
        logMessage('Getting Part 1 document... (takes about 15s)');
        google.script.run
          .withSuccessHandler(function(content) {
            // Calculate and display word count
            var wordCount = content.trim().split(/\s+/).length;
            document.getElementById('manuscript-context').innerHTML = 'Part 1 Word count: ' + wordCount;
            logMessage('Part 1 loaded, generating prompt...');
            
            // Now generate and copy the prompt
            generatePromptAndCopyToClipboard();
          })
          .withFailureHandler(function(error) {
            logMessage('Error: ' + error);
          })
          .getPart1Doc();
      }
      
      // Get Part 2 document and generate prompt
      function getPart2DocAndPrompt() {
        logMessage('Getting Part 2 document... (takes about 15s)');
        google.script.run
          .withSuccessHandler(function(content) {
            // Calculate and display word count
            var wordCount = content.trim().split(/\s+/).length;
            document.getElementById('manuscript-context').innerHTML = 'Part 2 Word count: ' + wordCount;
            logMessage('Part 2 loaded, generating prompt...');
            
            // Now generate and copy the prompt
            generatePromptAndCopyToClipboard();
          })
          .withFailureHandler(function(error) {
            logMessage('Error: ' + error);
          })
          .getPart2Doc();
      }
    </script>
  </body>
</html>

































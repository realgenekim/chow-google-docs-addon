<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      .content-box {
        margin-bottom: 15px;
      }
      .content-box h4 {
        margin: 0;
        color: #333;
        font-size: 14px;
      }
      .output-panel {
        margin-top: 10px;
        white-space: pre-wrap;
        border: 1px solid #e0e0e0;
        padding: 12px;
        border-radius: 4px;
        background-color: #ffffff;
        min-height: 50px;
        color: #333;
        cursor: default;
        box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
        user-select: text;
        -webkit-user-select: text;
      }
    </style>
  </head>
  <body>
    <h3>CHOW Workbench 3</h3>
    <p>Written to make it easier to CHOW: assemble and sling prompts around to paste them into an LLM.</p>
    <br>
        
    <div class="content-box">
      <h4>Selected Text</h4>
      <div id="selected-text" class="output-panel"></div>
    </div>

    <div class="content-box">
      <h4>Manuscript Context</h4>
      <div id="manuscript-context" class="output-panel">
        Manuscript not loaded: click "Get Document" to load
      </div>
    </div>

    <br>

    <button onclick="reloadSidebar()">Reload Sidebar</button>
    <button onclick="getDoc()">Read Source Docs</button>
    <button onclick="getSelection2()">Get Selection</button>
    <button onclick="copyToClipboard()">Generate Prompt and Copy to Clipboard</button>  
    <div id="debug" style="margin-top: 20px; color: red;"></div>

    <script>
      document.getElementById('debug').innerHTML += '<br>BEGIN!';

      // Run these functions when the sidebar loads
      window.onload = function() {
        loadInitialState();
      }

      // execute this: populate initial state
      function loadInitialState() {
        getDoc();
        getSelection2();
      }

      function getSelection2() {
        document.getElementById('debug').innerHTML += '<br>getSelection called';
        google.script.run
          .withSuccessHandler(function(text) {
            document.getElementById('debug').innerHTML += '<br>Success handler called with text: ' + text;
            document.getElementById('selected-text').innerHTML = text;
            google.script.run.withSuccessHandler(function() {
              document.getElementById('debug').innerHTML += '<br>Selection saved to global variable';
            }).setGlobalSelection(text);
          })
          .withFailureHandler(function(error) {
            document.getElementById('debug').innerHTML += '<br>Error: ' + error;
          })
          .getSelectedText();
      }

      function getDoc() {
        document.getElementById('debug').innerHTML += '<br>getDoc called!';
        google.script.run
          .withSuccessHandler(function(content) {
            const wordCount = content.trim().split(/\s+/).length;
            document.getElementById('manuscript-context').innerHTML = `Word count: ${wordCount}`;
          })
          .withFailureHandler(function(error) {
            document.getElementById('debug').innerHTML += '<br>Error: ' + error;
          })
          .getDoc();
        document.getElementById('debug').innerHTML += '<br>getDoc returned (takes about 10s to finish loading)!';
      }

      function reloadSidebar() {
        // Call the server function to reload the sidebar.
        google.script.run
          .withSuccessHandler(() => {
            console.log('Sidebar reloaded successfully.');
          })
          .withFailureHandler((error) => {
            console.error('Error reloading sidebar: ', error);
          })
          .showSidebar();
      }

      async function copyToClipboard() {
        try {
          await navigator.clipboard.writeText('abc');
          document.getElementById('debug').innerHTML += '<br>Copied to clipboard!';
        } catch (err) {
          document.getElementById('debug').innerHTML += '<br>Failed to copy: ' + err;
        }
      }
    </script>
  </body>
</html>
